---
id: ARCH-stager-templates
title: "Компонент: Шаблони Стейджерів"
type: component
layer: application
owner: "@AI-DocArchitect"
version: v1
status: current
created: 2025-06-02
updated: 2025-06-02
tags: [backend, payload, stager, template, generation]
depends_on:
  - ARCH-config
referenced_by: []
---
## Контекст
Компонент `stager_templates.py` є частиною модуля генератора пейлоадів і відповідає за надання логіки та шаблонів для генерації коду різних архетипів стейджерів. Він динамічно формує Python-код стейджера, вбудовуючи в нього обфусковані параметри, ключ обфускації та іншу необхідну логіку виконання.

## Структура
Основний файл: `CYBER_DASHBOARD_BACKEND/payload_generator/stager_templates.py`.

Ключовий елемент:
- Функція `generate_stager_code_logic(archetype_name, obfuscation_key, obfuscated_data_b64, validated_params, log_messages)`:
    - Приймає назву архетипу, ключ обфускації, обфусковані дані в Base64, валідовані параметри пейлоада та список для логування.
    - Містить велику кількість умовних блоків (`if archetype_name == ...`) для генерації специфічного коду для кожного підтримуваного архетипу.
    - Вбудовує в код стейджера:
        - Версію backend, мітку часу, назву архетипу.
        - Ключ обфускації (`OBFUSCATION_KEY_EMBEDDED`).
        - Обфусковані параметри пейлоада в Base64 (`OBF_DATA_B64`).
        - Прапорці для метаморфізму та технік ухилення.
        - Специфічні константи для стейджера (наприклад, `STAGER_IMPLANT_ID`, `BEACON_INTERVAL_SEC`).
        - Необхідні імпорти Python.
        - Функції часу виконання: `dx_runtime` (декодування), `ec_runtime` (перевірки ухилення), `ex_runtime` (основна логіка пейлоада).
        - Логіку виконання для кожного архетипу всередині функції `ex_runtime`.

Підтримувані архетипи (визначаються логікою всередині `generate_stager_code_logic`):
- `demo_echo_payload`
- `demo_file_lister_payload`
- `demo_c2_beacon_payload` (з логікою маячка, обробки завдань, ексфільтрації файлів)
- `dns_beacon_c2_concept` (з логікою DNS маячка та отримання завдань)
- `reverse_shell_tcp_shellcode_windows_x64` / `linux_x64` (з логікою ін'єкції шеллкоду)
- `powershell_downloader_stager`
- `windows_simple_persistence_stager`

## Поведінка
- Компонент викликається з `payload_generator/logic.py` під час процесу генерації пейлоада.
- На основі переданих параметрів генерує багаторядковий Python-код, який представляє собою готовий до виконання стейджер.
- Цей код потім може бути далі оброблений (наприклад, метаморфізмом) або переданий користувачеві.

## Еволюція
### Заплановано
- Можливе винесення шаблонів у окремі файли для кращої читабельності.
- Додавання підтримки нових архетипів стейджерів.
### Історичне
- v1: Реалізація генерації коду для всіх основних архетипів, включаючи логіку виконання та вбудовування параметрів. 